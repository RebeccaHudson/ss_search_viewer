{% load staticfiles %}
<head>
  <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>atSNP Search</title>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <link href="{% static 'ss_viewer/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'ss_viewer/custom.css' %}" rel="stylesheet">
  <link href="{% static 'ss_viewer/plot-styles.css' %}" rel="stylesheet"> 
  
  <script src="http://d3js.org/d3.v3.min.js"></script>
   
   <script type="text/javascript" src="{% static 'ss_viewer/cloneTheSkeleton.js' %}"> </script>  
   <script type="text/javascript" src="{% static 'ss_viewer/plotIntoSVGSkeleton.js' %}"> </script> 
   <script type="text/javascript" src="{% static 'ss_viewer/spin.min.js' %}"> </script> 
   <script type="text/javascript" src="{% static 'ss_viewer/setupSearchDemos.js' %}"> </script> 
   <script type="text/javascript" src="{% static 'ss_viewer/setupCSRF.js' %}"> </script> 
   <script type="text/javascript" src="{% static 'ss_viewer/js/dist/jszip.min.js' %}"></script>
   <script type="text/javascript" src="{% static 'ss_viewer/js/FileSaver.min.js' %}"></script>

</head>
<body>
<!-- <div class="container-fluid"> was there a good reason not to just
                                   have this as 'container'?   -->
<div class="container">
<div id="content">
{% include "ss_viewer/navbar.html" with active='searches' %}

<div class="side"> 

<ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
  <li  {%if active_tab == 'snpid' or active_tab == 'none-yet'%}class="active"{%endif%}><a href="#snpid_search_form" data-toggle="tab"  >SNPid List</a></li>
  <li {%if active_tab == 'snpid-window'%}class="active"{%endif%}><a href="#snpid_window_form" data-toggle="tab" >SNPid Window</a></li>
  <li {%if active_tab == 'gl-region' %}
      class="active"
      {% endif %}><a href="#gl_region_search_form" data-toggle="tab">Genomic Location</a></li>
  <li {%if active_tab == 'gene-name'%}class="active"{%endif%}><a href="#gene_name_form" data-toggle="tab" >Gene</a></li>
  <li {%if active_tab == 'tf'%}class="active"{%endif%}><a href="#tf_search_form" data-toggle="tab" >Transcription Factor</a></li>
</ul>


<div id="tabbed-forms" class="tab-content">
{% include "ss_viewer/gl_search.html" %} 
{% include "ss_viewer/snpid_search.html" %}
{% include "ss_viewer/trans_factor_search.html" %}
{% include "ss_viewer/snpid_window_search.html" %}
{% include "ss_viewer/gene_name_search.html" %}
 <!-- if the nav tab ends here, you can independently scroll the search results -->
</div> <!-- close the 'side' div -->
</div> <!-- close the 'tabbed forms' div -->

<!--  this is the way that we will be displaying the plot -->
<div class="side plot">
   <div id="plots">
   {% include "ss_viewer/svg_skeleton.html" %}
   <!-- this should hide unless a plot is shown -->
   <!-- <button id="save_plot" type="button" style="display:none;" class="btn btn-link">
   Save Plot </button> -->
   </div>
</div>
 <canvas id="canvas" style="display:none;" width="800" height="370"></canvas>

<!-- this div will contain the search params to submit for paging -->
<div id='current_search_params' style="display:none;">
</div>


<span id='type_of_shown_results' style="display:none;" >
{% if active_tab  %}
  {{ active_tab }} 
{% endif %}
</span>


<div id="status_message"> {{ status_message }} </div>


<!-- Errors will be reported here when they are returned from AJAX requests -->
<div id="form_errors">
</div>

<div id="download_button" style="display:none;" >
    <input type="submit" name="action"
           value="Download Results"
           class="btn-xs btn-danger"
           onclick="clickDownloadResultsAJAX();" />
</div>


<div id="ajaxyPagingButtons" >
     <button type="button"
             onclick='pagingAJAX("Prev");'
             style="display:none;"
             id="prev_button">
             Previous</button>
     <button type="submit" 
             onclick='pagingAJAX("Next");'
             style="display:none;"
             id="next_button">
             Next</button>
</div>

<div id="drop-in"></div>

</div> <!-- close the 'content' div -->
</div> <!-- close the 'container' div -->

<!-- TODO: ensure this is handled in <head> and get it out of here. -->
<script src="{% static 'ss_viewer/js/bootstrap.min.js' %}"></script>

<script type="text/javascript">
    jQuery(document).ready(function ($) {

        $('#tabs').tab();

        /* have JASPAR selected by default */
            $('#id_encode_trans_factor').attr('disabled', 'disabled');
            $('#id_tf_library_0').attr('checked', 'checked');
            $('#id_tf_library_1').removeAttr('checked');

        /* enable and disable the Transcription Factor selectors based 
           on which one the user is going to search*/
        $('#id_tf_library').change(function(e){
             var target_val = e.target.attributes.getNamedItem('value');
             if (target_val.value == 'encode'){
                $("#id_trans_factor").attr('disabled', 'disabled');
                $("#id_encode_trans_factor").removeAttr('disabled'); }
             if ( target_val.value == 'jaspar'){
                $("#id_encode_trans_factor").attr('disabled', 'disabled');
                $("#id_trans_factor").removeAttr('disabled');
               }
         });
    setupSearchDemos();

    /* blank out the snpdis requested if the file upload button is clicked. */
    $("#id_file_of_snpids").click(function(e)  { $("#id_raw_requested_snpids").val(""); }); 
  
    drawPlotsInline();

    //Event listeners to submit forms asynchronously. 
    setupAjaxyFormSubmissions();

    });//end of document.ready stuff.


    //Draws plots in-line inside the table of search results.
    function drawPlotsInline(){
       /* plotting data from each of the searched items.*/
       //moved into a function for calling when AJAX results are returned.
       var plottingData = [];
       $("td.plotting_data" ).each(function() {
           var data_for_one_plot = this.textContent;
           onePlotData = jQuery.parseJSON(data_for_one_plot);
           plottingData.push(onePlotData);
           //console.log("preparing for one plot.. " + data_for_one_plot ); 
       });
       cloneSVGSkeleton(plottingData);
       $("svg#target-0").hide();
       for ( var n = 0; n < plottingData.length; n++){
           var targetSVGid = "target-" + plottingData[n].plot_id_str;
           //console.log("creating plot for id : " + targetSVGid);
           makeAPlot(plottingData[n], targetSVGid);
           if ( n > 0 ){
             //console.log("adding hidden class to " + targetSVGid);
             $("#"+targetSVGid).parent().addClass("hidden");
           }else {
             //$("#save_plot").attr('style', 'display: inline;');
             $("#"+targetSVGid).parent().addClass("show-plot");
           } 
       } 
       console.log("completed plotting!");
    }


    //add this as an event listener for the inline plot downloads.
    //for the 'download plot' button that's inline.
    function handleInlinePlotDownload(){
         console.log("hit the function to  handleInlinePlotDownload");
         var svg = document.querySelector('div.show-plot > svg');
         svg = svg.cloneNode(true); //makes a deep copy.
         svg.setAttribute("id", "tempSVG");

         var defs = d3.select(svg).insert("defs", ":first-child").append("marker")
                                   .attr("id","Triangle")
                                   .attr("markerWidth","5")
                                   .attr("markerHeight","3")
                                   .attr("stroke", "blue")
                                   .attr("orient", "auto")
                                   .attr("viewBox", "0 0 10 10")
                                   .attr('refX', '1')
                                   .attr('refY', '5')
                                   .append("path").attr("d", "M 0 0 L 10 5 L 0 10 z");
          
          var canvas = document.getElementById('canvas');
          canvas.setAttribute('width',  $("div.show-plot svg").attr('width'));

          var ctx = canvas.getContext('2d');

          // Reset the canvas to remove any plots drawn before this one 
          //taken from :http://www.html5canvastutorials.com/advanced/html5-clear-canvas/ 
          ctx.clearRect(0, 0, canvas.width, canvas.height);

     
          var data = (new XMLSerializer()).serializeToString(svg);
          svgImage(data);

    }//end of 'Download Plot' button click event listener.
    //end of the plot downloading code.



//adapted from: https://spin.atomicobject.com/2014/01/21/convert-svg-to-png/
function svgImage(xml) {
  var image = new Image();
  image.src = 'data:image/svg+xml;base64,' + window.btoa(xml);
  //window.btoa(unescape(encodeURIComponent(xml)))}
  image.onload = function() {
  var canvas = document.createElement('canvas');
  canvas.width = image.width;
  canvas.height = image.height;
  var context = canvas.getContext('2d');

  //400 - 30 = 370
  context.drawImage(image, 0, -30);

  var fname = $('div.show-plot svg').attr('id').replace('target-', '');
  var a = document.createElement('a');
  a.download = fname + ".png";
  a.href = canvas.toDataURL('image/png');
  document.body.appendChild(a);
  a.click();
}
}


    function setupAjaxyFormSubmissions(){
     //beginning of AJAXY search handling code.   
     //could be nicely refactored.
     $("#snpid_window_form").on('submit', function(event){
         event.preventDefault();
         hideControlsDuringSearch();
         create_search_post('search', 'snpid-window-search');
     });
     $("#snpid_search_form").on('submit', function(event){
         event.preventDefault();  //works fine here?
         hideControlsDuringSearch();
         create_search_post('search', 'snpid-search');
     });
     $("#gl_region_search_form").on('submit', function(event){
         event.preventDefault();  //works fine here?
         hideControlsDuringSearch();
         create_search_post('search', 'gl-region-search');
     });
     $("#gene_name_form").on('submit', function(event){
         event.preventDefault();
         hideControlsDuringSearch();
         create_search_post('search', 'gene-name-search');
     });
     $("#tf_search_form").on('submit', function(event){
         event.preventDefault();
         hideControlsDuringSearch();
         create_search_post('search', 'trans-factor-search');
     });
    }
    function hideControlsDuringSearch(){
         $("div#form_errors").empty();
         $("#search_results").remove();   
         $("#drop-in").empty();
    }

    function showHidePrevNext(search_paging_info){
        if ( (search_paging_info != null) && (search_paging_info.show_next_btn) ){
          $("#ajaxyPagingButtons #next_button").attr("style", "display:inline;"); 
        }else{
          $("#ajaxyPagingButtons #next_button").attr("style", "display:none;"); 
        }
        if ( (search_paging_info != null) && (search_paging_info.show_prev_btn) ){
          $("#ajaxyPagingButtons #prev_button").attr("style", "display:inline;"); 
        }else{ 
          $("#ajaxyPagingButtons #prev_button").attr("style", "display:none;"); 
        }
    }


    function setupPlotsForSearchResults(){
       //the two blocks below can be factored together.
        $("td.show_plots > button[id^='show_plot']").click(function(e) {
            var plot_button_id = e.target.attributes.getNamedItem('id').value;
            var plot_str = plot_button_id.replace('show_plot_', '');
            console.log("plot_str: " + plot_str);
            /*  hiding the shown plot breaks if it's not there..*/
            var currently_shown_plot = $("div.show-plot");
            if (currently_shown_plot.length > 0){
                currently_shown_plot.removeClass('show-plot');
                currently_shown_plot.addClass('hidden'); 
                var download_button_to_hide = currently_shown_plot
                                             .parent()
                                             .find('button[id^="download_plot"]');
                download_button_to_hide.hide();
            }
            var id_of_plot_svg = 'target-'.concat(plot_str); 
            var plot_selector = 'svg#'.concat(id_of_plot_svg);
            console.log("show plot was clicked, id = " + id_of_plot_svg);
            var div_to_show_now = $(plot_selector).parent();
            console.log("div_to_show_now = ");
            console.log( div_to_show_now );
            var download_button =  div_to_show_now.parent().find('button[id^="download_plot"]');
            download_button.show();
            
            div_to_show_now.removeClass('hidden');
            div_to_show_now.addClass('show-plot');
            $(plot_selector).attr('style', 'display: inline;');
        }); 

        var download_plot_buttons = $("td.show_plots > button[id^='download_plot']");
        download_plot_buttons.click(function(e) {
                  handleInlinePlotDownload();
         }); 
        download_plot_buttons.hide(); //show when the corresponding 'show plot' is clicked.
        console.log("hiding the download buttons.");
 
       var plottingData = [];
       $("td.plotting_data" ).each(function() {
           var data_for_one_plot = this.textContent;
           onePlotData = jQuery.parseJSON(data_for_one_plot);
           plottingData.push(onePlotData);
       });
       cloneSVGSkeleton(plottingData);
       $("svg#target-0").hide();
       for ( var n = 0; n < plottingData.length; n++){
           var targetSVGid = "target-" + plottingData[n].plot_id_str;
           //console.log("creating plot for id : " + targetSVGid);
           makeAPlot(plottingData[n], targetSVGid);
           if ( n > 0 ){
             //console.log("adding hidden class to " + targetSVGid);
             $("#"+targetSVGid).parent().addClass("hidden");
           }else {
             $("#save_plot").attr('style', 'display: inline;');
             $("#"+targetSVGid).parent().addClass("show-plot");
           } 
           var plotToMove = $("#"+targetSVGid).parent().detach();
           var idOfPlotTarget = "#" + targetSVGid.replace('target-', 'show_plot_');
           var putPlotHere = $(idOfPlotTarget).parent();
           plotToMove.appendTo(putPlotHere);
       } 
       console.log("completed plotting!");
      }

          //take the search results and put them into the document.
          function show_search_results(json) {
            showHidePrevNext(json.search_paging_info);
            //if it's null, no buttons will be shown.

            $("#download_button").attr("style", "display: inline;");
            var content = `<table id="search_results" class="table table-striped table-condensed"> \
              <thead>                                                         \   
              <tr>                                     \ 
                  <td>SNPid                    </td>   \ 
                  <td>Chromosome               </td>   \ 
                  <td>Position                 </td>   \ 
                  <td>Reference Allele         </td>   \ 
                  <td>SNP Allele               </td>   \ 
                  <td>p-value Rank             </td>   \ 
                  <td>Log Likelihood Reference </td>   \ 
                  <td>Log Likelihood SNP       </td>   \ 
                  <td>Log Likelihood Ratio     </td>   \ 
                  <td>p-value Reference        </td>   \ 
                  <td>p-value SNP              </td>   \ 
                  <td>p-value Difference       </td>   \ 
                  <td>Transcription Factor     </td>   \ 
                  <td>Motif                    </td>   \ 
                  <td>Show Plot                </td>   \ 
              </tr>                                    \ 
              </thead>                                 \ 
              <tbody>`;                                
              $("#drop-in").append(content);
              var rows = "";
              for (var i = 0; i < json.api_response.length; i ++){
                  rows += "<tr>";
                  rows += "<td>" + json.api_response[i].snpid + "</td>";   
                  rows += "<td>" + json.api_response[i].chr + "</td>";   
                  rows += "<td>" + json.api_response[i].pos.toLocaleString() + "</td>";   
                  rows += "<td>" + json.api_response[i].refAllele + "</td>";   
                  rows += "<td>" + json.api_response[i].snpAllele + "</td>";   
                  rows += "<td>" + json.api_response[i].pval_rank.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].log_lik_ref.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].log_lik_snp.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].log_lik_ratio.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].pval_ref.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].pval_snp.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].pval_diff.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].trans_factor + "</td>";   
                  rows += "<td>" + json.api_response[i].motif + "</td>";   
                  rows += '<td class="show_plots"> <button id="show_plot_' 
                           + json.api_response[i].plot_id_str + '" type="button"';
                  rows +=  ' class="btn btn-link" plotstr="' + 
                            + json.api_response[i].plot_id_str + '" ' +
                            'title="Show the plot for this data.">'; 
                  rows += 'Show Plot</button><button id="download_plot_'
                  rows +=  json.api_response[i].plot_id_str + '" ' +
                            'title="Download the plot for this data.">' +
                            'Download Plot</button></td>'; 
                  //rows += 'Show Plot</button></td>';
                  rows += '<td id="plot_data_'  + json.api_response[i].plot_id_str +  '" style="display:none;"';
                  rows += ' class="plotting_data">' + json.api_response[i].json_for_plotting + '</td>';
                  rows += "</tr>";
              }
              $("#drop-in table tbody").append(rows);
              setupPlotsForSearchResults(); //copied (should be fully moved) out of document.ready
          }//end of show_search_results function.


       //TODO: determine if search type is a needed parameter for these.
       function create_search_post(action_name, search_type){
         var formElement = document.querySelector('div.active form');
         form_data = new FormData(formElement); 
         
         form_data.append('search_type', search_type);
         form_data.append('action',  action_name);
         var url_endpoint = 'ajaxy-' + search_type + '/';

         $("div#status_message").text("Working... ");
         $("div#download_button").attr("style", "display:none;");

         showHidePrevNext(null); 
         //hides the search buttons while we are working...

          $.ajax({
              beforeSend: function(xhr, settings) {
                   if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                       xhr.setRequestHeader("X-CSRFToken", csrftoken);
                   }
                   var target = $("body");
                   var spinner = new Spinner().spin();
                   target.append(spinner.el);
                   console.log("appended spinner!");
              },
              url: url_endpoint, 
              type: "POST", 
              data: form_data,   
              processData: false,
              cache: false,
              contentType: false,
             
              success: function(json) {
                  console.log("AJAX call reported success. Next line w/ response");
                  console.log(json);
                  $("div#status_message").text(json.status_message);

                  if ( json.api_response != null){
                      show_search_results(json);
                  }

                  //save data about the search onto the page: 
                  //search type
                  $("#type_of_shown_results").text(search_type);

                  //what about just grabbing the form data that is sent back?
                  console.log(json.form_data); //try to grab the values out of here.

                  //JSON dict containing search params that correspond to any 
                  //search results shown.
                  
                   var values = {};

                  values = json.form_data; //does it work to just store the dict directly and re-copy it?
                  if (json.search_paging_info != null){ 
                      values.page_of_results_shown =
                              json.search_paging_info.page_of_results_to_display;
                      console.log("...setting page number of results shown to:" + values.page_of_results_shown);
                  }
                  //this should contain a correct version of page_of_results_shown.
                  var values_to_save_for_paging = JSON.stringify(values);
                  console.log("values to persist after successful search: " + values_to_save_for_paging);
                  $("div#current_search_params").text(values_to_save_for_paging);

              },
              error: function(xhr, errmsg, err) {
                  /* would put code down here to append error messages onto the search page.*/
                  console.log(xhr.status + ": " + xhr.responseText);
                  //MOVE THIS TO ITS OWN FUNCTION:
                  var errorJSON = jQuery.parseJSON(xhr.responseText);
                  var errlist = '<ul>';
                  for ( var j = 0; j < errorJSON.form_errors.length; j++){
                      errlist += '<li>' + errorJSON.form_errors[j] + '</li>';
                  } 
                  errlist += '</ul>';
                  $("div#form_errors").append(errlist);
                  $("div#status_message").text(errorJSON.status_message);
                  showHidePrevNext(null); //hides the next and previous buttons.
              },
              complete: function(){
                  console.log("complete is acctually happenning; do shared stuff if this triggers for success AND error.");
                  $("div.spinner").remove();
              }
          });              
       }

       //search type should already be present.
       //some of this can be factored out...
       function create_paging_post(action_name, search_type){
         var val_text = $("div#current_search_params").text();
         var values = jQuery.parseJSON(val_text);
         values['action'] = action_name
         var url_endpoint = 'ajaxy-' + search_type + '/';
         $("div#status_message").text("Working... ");
         $("div#download_button").attr("style", "display:none;");
         showHidePrevNext(null); 
         //hides the search buttons while we are working...

          console.log("about to send ajax to endpoint " +
                      url_endpoint +  " with these values:");
          console.log(values);
          $.ajax({
              beforeSend: function(xhr, settings) {
                   if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                       xhr.setRequestHeader("X-CSRFToken", csrftoken);
                   }
                   var target = $("body");
                   var spinner = new Spinner().spin();
                   target.append(spinner.el);
                   console.log("appended spinner!");
              },
              url: url_endpoint, //url: "ajaxy-snpid-window-search/",
              type: "POST", 
              data: values , 
             
              success: function(json) {
                  console.log("PAGING: AJAX call reported success. Next line w/ response");
                  console.log(json);

                  //this should contain a correct version of page_of_results_shown.
                  $("div#status_message").text(json.status_message);

                  if ( json.api_response != null){
                      show_search_results(json);
                  }
                  if (json.search_paging_info != null){ 
                      values.page_of_results_shown =
                              json.search_paging_info.page_of_results_to_display;
                      console.log("...setting page number of results shown to:" + values.page_of_results_shown);
                  }
                  var values_to_save_for_paging = JSON.stringify(values);
                  $("div#current_search_params").text(values_to_save_for_paging);
              },
              error: function(xhr, errmsg, err) {
                  console.log(xhr.status + ": " + xhr.responseText);
                  //MOVE THIS TO ITS OWN FUNCTION: can be shared 
                  var errorJSON = jQuery.parseJSON(xhr.responseText);
                  var errlist = '<ul>';
                  for ( var j = 0; j < errorJSON.form_errors.length; j++){
                      errlist += '<li>' + errorJSON.form_errors[j] + '</li>';
                  } 
                  errlist += '</ul>';
                  $("div#form_errors").append(errlist);
                  $("div#status_message").text(errorJSON.status_message);
                  showHidePrevNext(null); //hides the next and previous buttons.
              },
              complete: function(){
                  console.log("complete is acctually happenning; do shared stuff if this triggers for success AND error.");
                  $("div.spinner").remove();
              }
          });              
       }


       //may be factored back into other create_post function; separate for now.

      //SOURCE:
      //http://stackoverflow.com/questions/28165424/download-file-via-jquery-ajax-post
      function create_download_post(search_type) {
          var val_text = $("div#current_search_params").text();
          values = jQuery.parseJSON(val_text);
          values['action'] = 'Download Results';
          var result_text = $("div#status_message").text();
          $("div#status_message").text("Working... ");

          var url_endpoint = 'ajaxy-' + search_type + '/';

          xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
              var a;
              if (xhttp.readyState === 4 && xhttp.status === 200) {
                  a = document.createElement('a');
                  a.href = window.URL.createObjectURL(xhttp.response);
                  a.download = "search-results-download.csv";
                  a.style.display = 'none';
                  document.body.appendChild(a);
                  a.click();
                  $("div#status_message").text(result_text);
              }
          };
          xhttp.open("POST", url_endpoint);
          xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
          xhttp.setRequestHeader("X-CSRFToken", csrftoken);
         
          console.log("values for submitting for download; "+ values);

          // You should set responseType as blob for binary responses
          xhttp.responseType = 'blob';
          xhttp.withCredentials = true;
          xhttp.send(JSON.stringify(values));
        }

      function pagingAJAX(nextOrPrev){
        var active_search = $("span#type_of_shown_results")[0].innerText.trim();
        //copied out of the form's on_submit event handler  
        $("div#form_errors").empty();
        $("#search_results").remove();   
        $("#drop-in").empty();
        create_paging_post(nextOrPrev, active_search);
      }

      //this may need to change.
      function clickDownloadResultsAJAX(){
           var active_search = $("span#type_of_shown_results")[0].innerText.trim();
           create_download_post(active_search); //action name, search type
      }
































































    //Clones the node with the currently shown plot, 
    //adds definitions for the Arrowhead markers.
    //sets up an HTML <canvas> element, including appropriate width,
    //serizlizes the SVG copy into a string of XML.
    function setupBulkPlotDownload(svg){
         console.log("bulk download for svg selector: " + svg );
         svg = svg.cloneNode(true); //makes a deep copy.
         svg.setAttribute("id", "tempSVG");
         var defs = d3.select(svg).insert("defs", ":first-child").append("marker")
                                   .attr("id","Triangle")
                                   .attr("markerWidth","5")
                                   .attr("markerHeight","3")
                                   .attr("stroke", "blue")
                                   .attr("orient", "auto")
                                   .attr("viewBox", "0 0 10 10")
                                   .attr("refX", "1")
                                   .attr("refY", "5")
                                   .append("path").attr("d", "M 0 0 L 10 5 L 0 10 z");
          svg.setAttribute('style', 'display:inline;'); //unhide, or images will be BLANK!
          var data = (new XMLSerializer()).serializeToString(svg);
          return data;
    }


      //xml is the SVG source, ctx is the context element.
      function getImgFromXML(xml, canvas, ctx){ 
          DOMURL = window.URL || window.webkitURL || window;
          var img = new Image();
          img.src = 'data:image/svg+xml;base64,' + window.btoa(xml);
          var dataURL;
          img.onload = function() {
            //var canvas = document.createElement('canvas');
            //var context = canvas.getContext('2d');
            ctx.drawImage(img, 0, -30);
            dataURL = canvas.toDataURL('image/png'); 
            console.log("dataurl inside of onload; " + dataURL);
          }   
      }

    //should return a file-like object that can be a successful argument to zip.file().
    //adapted from: https://spin.atomicobject.com/2014/01/21/convert-svg-to-png/
    function svgImageBulk(xml ) {
    }

    function zipper(){
      var zip = new JSZip();
      zip.file("Hello.txt", "Hello World\n");
      var one_plot = setupBulkPlotDownload(zip);
      console.log("is there source for a plot here? -> " + one_plot);
      console.log("one plot as base64 " + one_plot);
      one_plot = one_plot.replace("data:image/png;base64,", '');
      console.log("one plot after trimming: ", one_plot);
      zip.file('one_picture.png', one_plot,{base64: true});
      zip.generateAsync({type:"blob"})
        .then(function (blob) {
            saveAs(blob, "hello.zip");
            console.log("successful async...");
        });
      console.log("completing zipper function");
      return one_plot;
     }

// bulk downloads; it's messy. trying suff from 
//http://stackoverflow.com/questions/31384408/how-to-get-multiple-files-via-ajax-and-download-them-as-a-zip-file-via-javascrip 
  function bd(){
         var images = [];
         var counter = 0;
          
         var targets = $('svg[id^="target"]');
        
         for (var i = 0; i< targets.length; i++) {
            convertImgToBase64URL(targets[i], function (base64Img, url) {
              var tag = "file-" + i;
              var dataForOnePlot = base64Img.replace("data:image/png;base64,", '');
              images.push({
                data: dataForOnePlot,
                tag: tag 
              });
              counter++;
              if (counter == targets.length) {
                console.log("calling createArchive!");
                createArchive(images);
              }
            });
          }
  }      


function convertImgToBase64URL(svgSelector, callback){
    var img = new Image();
    var url = "imgtest";
    var fname_for_plot = svgSelector.getAttribute("id");
    console.log("fname_for_plot: " + fname_for_plot);
    var xml = setupBulkPlotDownload(svgSelector);
    img.onload = function(){
      var canvas = document.createElement('canvas'),
      ctx = canvas.getContext('2d'), dataURL;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      canvas.height = this.height;
      canvas.width = this.width;
      ctx.drawImage(img, 0, -30);
      dataURL = canvas.toDataURL('image/png');
      callback(dataURL, url);
    };
    img.src = 'data:image/svg+xml;base64,' + window.btoa(xml);
}

function createArchive(images){
  // Use jszip
  console.log("called created archive!");
  console.log("length of images: " + images.length);
  var zip = new JSZip();
  for (var i=0; i<images.length; i++) {
    var  fname = 'onedog-' + i + '.png';
    zip.file(fname, images[i].data, {base64: true});  
  }
  console.log("completed the for loop in createArchive");
  zip.generateAsync({type:"blob"})
     .then(function(blob){
     saveAs(blob, "images.zip");
  });
}























    $(".formcontrol").tooltip({
      position: "bottom left",
      offset: [-2, 10],
      opacity: 0.1
    });
</script>
</body>
