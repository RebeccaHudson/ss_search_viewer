{% load staticfiles %}
<head>
  <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>atsnp data</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <link href="{% static 'ss_viewer/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'ss_viewer/custom.css' %}" rel="stylesheet">
  <link href="{% static 'ss_viewer/plot-styles.css' %}" rel="stylesheet"> 
  
  <script src="http://d3js.org/d3.v3.min.js"></script>
   
   <script type="text/javascript" src="{% static 'ss_viewer/cloneTheSkeleton.js' %}"> </script>  
   <script type="text/javascript" src="{% static 'ss_viewer/plotIntoSVGSkeleton.js' %}"> </script> 

</head>
<body>
<!-- <nav class="navbar navbar-default navbar-fixed-top"> -->
<!-- <div class="container-fluid"> was there a good reason not to just
                                   have this as 'container'?   -->
<div class="container">
<div id="content">
{% include "ss_viewer/navbar.html" with active='searches' %}
<div id="status_message"> {{ status_message }} </div>

<div class="side"> 

<ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
  <li  {%if active_tab == 'snpid' or active_tab == 'none-yet'%}class="active"{%endif%}><a href="#snpid_search_form" data-toggle="tab"  >SNPid List</a></li>
  <li {%if active_tab == 'snpid-window'%}class="active"{%endif%}><a href="#snpid_window_form" data-toggle="tab" >SNPid Window</a></li>
  <li {%if active_tab == 'gl-region' %}
      class="active"
      {% endif %}><a href="#gl_region_search_form" data-toggle="tab">Genomic Location</a></li>
  <li {%if active_tab == 'gene-name'%}class="active"{%endif%}><a href="#gene_name_form" data-toggle="tab" >Gene</a></li>
  <li {%if active_tab == 'tf'%}class="active"{%endif%}><a href="#tf_search_form" data-toggle="tab" >Transcription Factor</a></li>
</ul>


<div id="tabbed-forms" class="tab-content">
{% include "ss_viewer/gl_search.html" %} 
{% include "ss_viewer/snpid_search.html" %}
{% include "ss_viewer/trans_factor_search.html" %}
{% include "ss_viewer/snpid_window_search.html" %}
{% include "ss_viewer/gene_name_search.html" %}
 <!-- if the nav tab ends here, you can independently scroll the search results -->
</div> <!-- close the 'side' div -->
</div> <!-- close the 'tabbed forms' div -->

<!--  this is the way that we will be displaying the plot -->
<div class="side plot">
   <div id="plots">
   {% include "ss_viewer/svg_skeleton.html" %}
   </div>
</div>

<!-- TODO: remove this chunk -->
{% if plot_source %}
<div class="side plot">
    {% if plot_source %}
        {% for plot_id_str, one_svg in plot_source.items %}
          <div id="plot_{{plot_id_str}}" class="{% if plot_id_str == first_plot_id_str %}show-plot{% else %}hide-plot{% endif %}" > 
              <!-- <p> {{ plot_id_str }} </p>   -->
              <a href="{{ one_svg }}"><img title="Click image for a full-sized version." src="{{ one_svg }}" alt="current plot"></a>
          </div>
        {% endfor %}
    {% endif %}
</div>
{% endif %}
<!-- consider making this part modular; DRYing it up some how... -->


<span id='type_of_shown_results' style="display:none;" >
{% if active_tab  %}
  {{ active_tab }} 
{% endif %}
</span>

{% if search_paging_info != None %}
   <div>
   {% if search_paging_info.show_next_btn == True %}
     <button type="submit" 
             onclick='clickNext();'>
             Next</button>
   {% endif %}

   {% if search_paging_info.show_prev_btn == True %}
     <button type="button"
             onclick='clickPrev();'>
             Previous</button>
   {% endif %}
   </div>
{% endif %} 

<div id="status_message"> {{ status_message }} </div>
  {% if api_response  %}
  <table class="table table-striped table-condensed"> 
    <thead>
    <tr>

        <td><a href="{% url 'ss_viewer:help-page' %}#snpid">SNPid                   </a>       </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#chromosome">Chromosome              </a>  </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#position">Position                </a>    </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#ref_allele">Reference Allele        </a>  </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#snp_allele">SNP Allele              </a>  </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#pval_rank" >p-value Rank            </a>  </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#log_lik_ref">Log Likelihood Reference</a> </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#log_lik_ratio">Log Likelihood Ratio   </a> </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#pval_ref">    p-value Reference       </a> </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#pval_snp">p-value SNP              </a>    </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#pval_diff">p-value Difference       </a>   </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#trans_factor">Transcription Factor </a>   </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#motif"> Motif                </a>         </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#has_plot">Plot Available     </a>         </td>
    </tr>
    </thead>
    <tbody>
    {% for onerow in api_response %}
    <tr>   
        <td> {{ onerow.snpid }}</td>
        <td> {{ onerow.chr }}</td>
        <td> {{ onerow.pos }}</td> 
        <td> {{ onerow.refAllele }}</td> 
        <td> {{ onerow.snpAllele }}</td> 
        <td> {{ onerow.pval_rank|stringformat:".3e"}} </td>
        <td> {{ onerow.log_lik_ref|stringformat:".3e"}} </td>
        <td> {{ onerow.log_lik_snp|stringformat:".3e"}} </td>  
        <td> {{ onerow.log_lik_ratio|stringformat:".3e"}} </td>
        <td> {{ onerow.pval_ref|stringformat:".3e" }} </td>
        <td> {{ onerow.pval_snp|stringformat:".3e" }} </td>
        <td> {{ onerow.pval_diff|stringformat:".3e" }}</td>  
        <td> {{ onerow.trans_factor }}</td>
        <td> {{ onerow.motif }} </td>
        <!-- plots are now available for ALL data -->
        <td class="show_plots"  >
                  <button id="show_plot_{{onerow.plot_id_str}}" 
                          type="button" class="btn btn-link" 
                          plotstr="{{onerow.plot_id_str}}"
                          title="Show the plot for this data."> 
                  Show Plot</button></td> 
       <!--  how to hide the hidden data -->
       <td id="plot_data_{{onerow.plot_id_str}}" style="display:none;"
       class="plotting_data" >{{ onerow.json_for_plotting }}</td>
       </tr>
    {%  endfor %}
    <tbody>
  </table>
  {% endif %}


</div> <!-- close the 'content' div -->
</div> <!-- close the 'container' div -->


    


<!-- TODO: ensure this is handled in <head> and get it out of here. -->
<script src="{% static 'ss_viewer/js/bootstrap.min.js' %}"></script>
<script type="text/javascript">
    jQuery(document).ready(function ($) {

        $('#tabs').tab();

        /* either have JASPAR selected by default, or if it's 
           what was being used before*/
        var prev_search_tf_lib = $("#id_prev_search_tf_library").val();
        if (  (  prev_search_tf_lib == '' )  ||  ( prev_search_tf_lib == 'jaspar'  ) ){
            $('#id_encode_trans_factor').attr('disabled', 'disabled');
            $('#id_tf_library_0').attr('checked', 'checked');
            $('#id_tf_library_1').removeAttr('checked');
        }else {
            /* select encode initially on page load if it is what was
               being searched in previously*/
            $('#id_trans_factor').attr('disabled', 'disabled');
            $('#id_tf_library_1').attr('checked', 'checked');
            $('#id_tf_library_0').removeAttr('checked');
        }

        /* enable and disable the Transcription Factor selectors based 
           on which one the user is going to search*/
        $('#id_tf_library').change(function(e){
             var target_val = e.target.attributes.getNamedItem('value');
             if (target_val.value == 'encode'){
                $("#id_trans_factor").attr('disabled', 'disabled');
                $("#id_encode_trans_factor").removeAttr('disabled'); }
             if ( target_val.value == 'jaspar'){
                $("#id_encode_trans_factor").attr('disabled', 'disabled');
                $("#id_trans_factor").removeAttr('disabled');
               }

         });
         //cloneSVGSkeleton(plottingData);
         /* end of document.ready stuff */

        /* clickable examples for demo searches */
        $("#snpid-search-demo").click(function(e){ 
                                       $('#id_raw_requested_snpids').val(
                                             'rs539483321, rs576894892, rs553761389, rs757299236, rs770590115');
                                        } );
        $("#gl-search-demo").click(function(e){
                                       $('#id_gl_start_pos').val(10000);
                                       $('#id_gl_end_pos').val(143511163);
                                       $('#id_selected_chromosome').val('ch5'); });
        $("#tf-search-demo").click(function(e){
                                      $('#id_trans_factor').val('NFYB'); 
                                        $('#id_encode_trans_factor').attr('disabled', 'disabled');
                                        $("#id_trans_factor").removeAttr('disabled');
                                        $('#id_tf_library_0').prop('checked', true);
                                        $('#id_tf_library_1').removeAttr('checked'); 
                                        });

        $("#snpid-window-search-demo").click(function(e){
                                      $('#id_snpid').val('rs755632525'); });
        $("#gene-name-search-demo").click(function(e){
                                      $('#id_gene_name').val('ELOVL1'); });
        $("td.show_plots > button").click(function(e) {
                                var plotstr_attr = e.target.attributes.getNamedItem('plotstr');
                                var plot_str  = plotstr_attr.value;
                                /* hides the currently shown plot */
                                //console.dir(e.target);
                                //var jtarget = $("td#plot_data_".concat(plot_str));
                                //var json_to_plot = jtarget[0].textContent.trim();

                               // plottingData = jQuery.parseJSON(json_to_plot); 
                                //console.log("json to plot: " + plottingData);
                                
                                // makeAPlot(plottingData, "target-0"); 
                                /* the code below would be useful for showing/hiding
                                   all of the plots prepared for this one page */ 
                                var currently_shown_plot = $("div.show-plot");
                                currently_shown_plot.removeClass('show-plot');
                                currently_shown_plot.addClass('hidden'); 
                                var id_of_plot_svg = 'target-'.concat(plot_str); 
                                var plot_selector = 'svg#'.concat(id_of_plot_svg);
                                var div_to_show_now = $(plot_selector).parent();
                                div_to_show_now.removeClass('hidden');
                                div_to_show_now.addClass('show-plot');
                                window.scrollTo(0, 0); /* scroll to the top of the page */
                               }); 

       /* blank out the snpdis requested if the file upload button is clicked. */
       $("#id_file_of_snpids").click(function(e)  { $("#id_raw_requested_snpids").val(""); }); 
  
       /* plotting data from each of the searched items.*/
       var plottingData = [];
       $("td.plotting_data" ).each(function() {
           var data_for_one_plot = this.textContent;
           onePlotData = jQuery.parseJSON(data_for_one_plot);
           plottingData.push(onePlotData);
           //console.log("preparing for one plot.. " + data_for_one_plot ); 
       });
       cloneSVGSkeleton(plottingData);
       $("svg#target-0").hide();
       for ( var n = 0; n < plottingData.length; n++){
           var targetSVGid = "target-" + plottingData[n].plot_id_str;
           console.log("creating plot for id : " + targetSVGid);
           makeAPlot(plottingData[n], targetSVGid);
           if ( n > 0 ){
             console.log("adding hidden class to " + targetSVGid);
             $("#"+targetSVGid).parent().addClass("hidden");
           }else {
             $("#"+targetSVGid).parent().addClass("show-plot");
           } 
       } 
       console.log("completed plotting!");
       //$( this ).addClass( "foo" );

       /*
       $("form").onsubmit = function(evt)  {
        var event = evt || window.event;
        alert("boo far");
        alert(event.target.id); // myform
        alert(event.explicitOriginalTarget.id); 
       }*/

    });//end of document.ready stuff.


      function clickNext(){
           var active_search = $("span#type_of_shown_results")[0].innerText.trim();
           if (active_search == 'snpid'){
              $("div#snpid_search_form input[value='Next']").click();
           } else if (active_search == 'snpid-window'){
              $("div#snpid_window_form input[value='Next']").click();
           } else if (active_search == 'gl-region'){
              $("div#gl_region_search_form input[value='Next']").click();
           } else if (active_search == 'gene-name'){
              $("div#gene_name_form input[value='Next']").click();
           } else if (active_search == 'tf'){
              $("div#tf_search_form input[value='Next']").click();
           }
      }

      function clickPrev(){
           var active_search = $("span#type_of_shown_results")[0].innerText.trim();
           if (active_search == 'snpid'){
              $("div#snpid_search_form input[value='Prev']").click();
           } else if (active_search == 'snpid-window'){
              $("div#snpid_window_form input[value='Prev']").click();
           } else if (active_search == 'gl-region'){
              $("div#gl_region_search_form input[value='Prev']").click();
           } else if (active_search == 'gene-name'){
              $("div#gene_name_form input[value='Prev']").click();
           } else if (active_search == 'tf'){
              $("div#tf_search_form input[value='Prev']").click();
           }
      }


    $(".formcontrol").tooltip({
      position: "bottom left",
      offset: [-2, 10],
      opacity: 0.1
    });
</script>

</body>
