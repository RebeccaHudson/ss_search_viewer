{% load staticfiles %}
<head>
  <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>atSNP Search</title>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <link href="{% static 'ss_viewer/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'ss_viewer/custom.css' %}" rel="stylesheet">
  <link href="{% static 'ss_viewer/plot-styles.css' %}" rel="stylesheet"> 
  
  <script src="http://d3js.org/d3.v3.min.js"></script>
   
   <script type="text/javascript" src="{% static 'ss_viewer/cloneTheSkeleton.js' %}"> </script>  
   <script type="text/javascript" src="{% static 'ss_viewer/plotIntoSVGSkeleton.js' %}"> </script> 
   <script type="text/javascript" src="{% static 'ss_viewer/spin.min.js' %}"> </script> 

</head>
<body>
<!-- <div class="container-fluid"> was there a good reason not to just
                                   have this as 'container'?   -->
<div class="container">
<div id="content">
{% include "ss_viewer/navbar.html" with active='searches' %}

<div class="side"> 

<ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
  <li  {%if active_tab == 'snpid' or active_tab == 'none-yet'%}class="active"{%endif%}><a href="#snpid_search_form" data-toggle="tab"  >SNPid List</a></li>
  <li {%if active_tab == 'snpid-window'%}class="active"{%endif%}><a href="#snpid_window_form" data-toggle="tab" >SNPid Window</a></li>
  <li {%if active_tab == 'gl-region' %}
      class="active"
      {% endif %}><a href="#gl_region_search_form" data-toggle="tab">Genomic Location</a></li>
  <li {%if active_tab == 'gene-name'%}class="active"{%endif%}><a href="#gene_name_form" data-toggle="tab" >Gene</a></li>
  <li {%if active_tab == 'tf'%}class="active"{%endif%}><a href="#tf_search_form" data-toggle="tab" >Transcription Factor</a></li>
</ul>


<div id="tabbed-forms" class="tab-content">
{% include "ss_viewer/gl_search.html" %} 
{% include "ss_viewer/snpid_search.html" %}
{% include "ss_viewer/trans_factor_search.html" %}
{% include "ss_viewer/snpid_window_search.html" %}
{% include "ss_viewer/gene_name_search.html" %}
 <!-- if the nav tab ends here, you can independently scroll the search results -->
</div> <!-- close the 'side' div -->
</div> <!-- close the 'tabbed forms' div -->

<!--  this is the way that we will be displaying the plot -->
<div class="side plot">
   <div id="plots">
   {% include "ss_viewer/svg_skeleton.html" %}
   <!-- this should hide unless a plot is shown -->
   <button id="save_plot" type="button" style="display:none;" class="btn btn-link">
   Save Plot </button>
   </div>
</div>
 <canvas id="canvas" style="display:none;" width="800" height="370"></canvas>

<!-- this div will contain the search params to submit for paging -->
<div id='current_search_params' style="display:none;">
</div>


<span id='type_of_shown_results' style="display:none;" >
{% if active_tab  %}
  {{ active_tab }} 
{% endif %}
</span>

<div id="status_message"> {{ status_message }} </div>


<!-- these will go away in favor of AJAXy stuff -->
<div id="form_errors">
{% if form_errors %}
<ul>
{% for one_error in form_errors %}
<li> {{ one_error }} </li>
{% endfor %}
</ul>
{% endif %}
</div>

<div id="download_button" style="display:none;" >
    <input type="submit" name="action"
           value="Download Results"
           class="btn-xs btn-danger"
           onclick="clickDownloadResultsAJAX();" />
</div>


<div id="ajaxyPagingButtons" >
     <button type="button"
             onclick='clickPrevAJAX();'
             style="display:none;"
             id="prev_button">
             Previous</button>
     <button type="submit" 
             onclick='clickNextAJAX();'
             style="display:none;"
             id="next_button">
             Next</button>
</div>





{% if search_paging_info != None %}<div>
   {% if search_paging_info.show_prev_btn == True %}
     <button type="button"
             onclick='clickPrev();'>
             Previous</button>
   {% endif %}
   {% if search_paging_info.show_next_btn == True %}
     <button type="submit" 
             onclick='clickNext();'>
             Next</button>
   {% endif %}
</div>{% endif %} 


  {% if api_response  %}
  <table id="search_results" class="table table-striped table-condensed"> 
    <thead>
    <tr>

        <td><a href="{% url 'ss_viewer:help-page' %}#snpid">SNPid                   </a>       </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#chromosome">Chromosome              </a>  </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#position">Position                </a>    </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#ref_allele">Reference Allele        </a>  </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#snp_allele">SNP Allele              </a>  </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#pval_rank" >p-value Rank            </a>  </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#log_lik_ref">Log Likelihood Reference</a> </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#log_lik_snp">Log Likelihood SNP</a> </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#log_lik_ratio">Log Likelihood Ratio   </a> </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#pval_ref">    p-value Reference       </a> </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#pval_snp">p-value SNP              </a>    </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#pval_diff">p-value Difference       </a>   </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#trans_factor">Transcription Factor </a>   </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#motif"> Motif                </a>         </td>
        <td><a href="{% url 'ss_viewer:help-page' %}#has_plot">Show Plot</a>         </td>
    </tr>
    </thead>
    <tbody>
    {% for onerow in api_response %}
    <tr>   
        <td> {{ onerow.snpid }}</td>
        <td> {{ onerow.chr }}</td>
        <td> {{ onerow.pos }}</td> 
        <td> {{ onerow.refAllele }}</td> 
        <td> {{ onerow.snpAllele }}</td> 
        <td> {{ onerow.pval_rank|stringformat:".3e"}} </td>
        <td> {{ onerow.log_lik_ref|stringformat:".3e"}} </td>
        <td> {{ onerow.log_lik_snp|stringformat:".3e"}} </td>  
        <td> {{ onerow.log_lik_ratio|stringformat:".3e"}} </td>
        <td> {{ onerow.pval_ref|stringformat:".3e" }} </td>
        <td> {{ onerow.pval_snp|stringformat:".3e" }} </td>
        <td> {{ onerow.pval_diff|stringformat:".3e" }}</td>  
        <td> {{ onerow.trans_factor }}</td>
        <td> {{ onerow.motif }} </td>
        <!-- plots are now available for ALL data -->
        <td class="show_plots"  >
                  <button id="show_plot_{{onerow.plot_id_str}}" 
                          type="button" class="btn btn-link" 
                          plotstr="{{onerow.plot_id_str}}"
                          title="Show the plot for this data."> 
                  Show Plot</button></td> 
       <!--  how to hide the hidden data -->
       <td id="plot_data_{{onerow.plot_id_str}}" style="display:none;"
       class="plotting_data" >{{ onerow.json_for_plotting }}</td>
       </tr>
    {%  endfor %}
    <tbody>
  </table>
  {% endif %}

<div id="drop-in"></div>

</div> <!-- close the 'content' div -->
</div> <!-- close the 'container' div -->


    


<!-- TODO: ensure this is handled in <head> and get it out of here. -->
<script src="{% static 'ss_viewer/js/bootstrap.min.js' %}"></script>

<script type="text/javascript">
    jQuery(document).ready(function ($) {

        $('#tabs').tab();

        /* have JASPAR selected by default */
            $('#id_encode_trans_factor').attr('disabled', 'disabled');
            $('#id_tf_library_0').attr('checked', 'checked');
            $('#id_tf_library_1').removeAttr('checked');

        /* enable and disable the Transcription Factor selectors based 
           on which one the user is going to search*/
        $('#id_tf_library').change(function(e){
             var target_val = e.target.attributes.getNamedItem('value');
             if (target_val.value == 'encode'){
                $("#id_trans_factor").attr('disabled', 'disabled');
                $("#id_encode_trans_factor").removeAttr('disabled'); }
             if ( target_val.value == 'jaspar'){
                $("#id_encode_trans_factor").attr('disabled', 'disabled');
                $("#id_trans_factor").removeAttr('disabled');
               }
         });
         //cloneSVGSkeleton(plottingData);
         /* end of document.ready stuff */

        /* clickable examples for demo searches */
        $("#snpid-search-demo").click(function(e){ 
                                       $('#id_raw_requested_snpids').val(
                                             'rs539483321, rs576894892, rs553761389, rs757299236, rs770590115');
                                        } );
        $("#gl-search-demo").click(function(e){
                                       $('#id_gl_start_pos').val(10000);
                                       $('#id_gl_end_pos').val(143511163);
                                       $('#id_selected_chromosome').val('ch5'); });
        $("#tf-search-demo").click(function(e){
                                      $('#id_trans_factor').val('NFYB'); 
                                        $('#id_encode_trans_factor').attr('disabled', 'disabled');
                                        $("#id_trans_factor").removeAttr('disabled');
                                        $('#id_tf_library_0').prop('checked', true);
                                        $('#id_tf_library_1').removeAttr('checked'); 
                                        });

        $("#snpid-window-search-demo").click(function(e){
                                      $('#id_snpid').val('rs755632525'); });
        $("#gene-name-search-demo").click(function(e){
                                      $('#id_gene_name').val('ELOVL1'); });
        $("td.show_plots > button").click(function(e) {
                                var plotstr_attr = e.target.attributes.getNamedItem('plotstr');
                                var plot_str  = plotstr_attr.value;
                                var currently_shown_plot = $("div.show-plot");
                                currently_shown_plot.removeClass('show-plot');
                                currently_shown_plot.addClass('hidden'); 
                                var id_of_plot_svg = 'target-'.concat(plot_str); 
                                var plot_selector = 'svg#'.concat(id_of_plot_svg);
                                var div_to_show_now = $(plot_selector).parent();
                                div_to_show_now.removeClass('hidden');
                                div_to_show_now.addClass('show-plot');
                                window.scrollTo(0, 0); /* scroll to the top of the page */
                               }); 

       /* blank out the snpdis requested if the file upload button is clicked. */
       $("#id_file_of_snpids").click(function(e)  { $("#id_raw_requested_snpids").val(""); }); 
  
       /* plotting data from each of the searched items.*/
       //moved into a function for calling when AJAX results are returned.
       var plottingData = [];
       $("td.plotting_data" ).each(function() {
           var data_for_one_plot = this.textContent;
           onePlotData = jQuery.parseJSON(data_for_one_plot);
           plottingData.push(onePlotData);
           //console.log("preparing for one plot.. " + data_for_one_plot ); 
       });
       cloneSVGSkeleton(plottingData);
       $("svg#target-0").hide();
       for ( var n = 0; n < plottingData.length; n++){
           var targetSVGid = "target-" + plottingData[n].plot_id_str;
           //console.log("creating plot for id : " + targetSVGid);
           makeAPlot(plottingData[n], targetSVGid);
           if ( n > 0 ){
             //console.log("adding hidden class to " + targetSVGid);
             $("#"+targetSVGid).parent().addClass("hidden");
           }else {
             $("#save_plot").attr('style', 'display: inline;');
             $("#"+targetSVGid).parent().addClass("show-plot");
           } 
       } 
       console.log("completed plotting!");

    //make the shown plot downloadable
    //start the plot downloading code.
    var btn = document.querySelector('button#save_plot');
    var canvas =  document.querySelector('canvas');
    
    function triggerDownload(imgURI) {
      console.log("triggering download.");
      var evt = new MouseEvent('click', {
        view: window,
        bubbles: false,
        cancelable: true
      });

      var a = document.createElement('a');
      var fname = $('div.show-plot svg').attr('id').replace('target-', '');
      a.setAttribute('download', fname + '.png');
      a.setAttribute('href', imgURI);
      a.setAttribute('target', '_blank');

      a.dispatchEvent(evt);
    }
     btn.addEventListener('click', function () {
     var svg = document.querySelector('div.show-plot > svg');
     svg = svg.cloneNode(true); //can I make a deep copy?
     svg.setAttribute("id", "tempSVG");
     // works OK
     //appends   the definitions
     var defs = d3.select(svg).append("defs").append("marker")
                                 .attr("id","Triangle")
                                 .attr("markerWidth","5")
                                 .attr("markerHeight","3")
                                 .attr("stroke", "blue")
                                 .attr("orient", "auto")
                                 .attr("viewBox", "0 0 10 10")
                                 .attr('refX', '1')
                                 .attr('refY', '5')
                                 .append("path").attr("d", "M 0 0 L 10 5 L 0 10 z");
      var canvas = document.getElementById('canvas');
      canvas.setAttribute('width',  $("div.show-plot svg").attr('width'));
      //400 - 30 = 370
      var ctx = canvas.getContext('2d');

      // Reset the canvas to remove any plots drawn before this one 
      //taken from :http://www.html5canvastutorials.com/advanced/html5-clear-canvas/ 
      ctx.clearRect(0, 0, canvas.width, canvas.height);

 
      var data = (new XMLSerializer()).serializeToString(svg);
      var DOMURL = window.URL || window.webkitURL || window;

      var img = new Image();
      console.log("just created new img.");
      var svgBlob = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
      var url = DOMURL.createObjectURL(svgBlob);

      img.onload = function () {
        console.log("about to call drawImage");
        ctx.drawImage(img, 0, -30);
        DOMURL.revokeObjectURL(url);

        //d3.selectAll('div.show-plot > svg > defs').remove();
        //console.log("remove defs..");

        var imgURI = canvas
            .toDataURL('image/png')
            .replace('image/png', 'image/octet-stream');

        triggerDownload(imgURI);
        console.log("returned from trigger download");
      };
  
      img.src = url;

      });
      //end of the plot downloading code.
   

    //submit forms asynchronously. 
    setupAjaxyFormSubmissions();


    });//end of document.ready stuff.

    function setupAjaxyFormSubmissions(){
     //beginning of AJAXY search handling code.   
     //could be nicely refactored.
     $("#snpid_window_form").on('submit', function(event){
         event.preventDefault();
         hideControlsDuringSearch();
         create_search_post('search', 'snpid-window-search');
     });
     $("#snpid_search_form").on('submit', function(event){
         event.preventDefault();  //works fine here?
         hideControlsDuringSearch();
         create_search_post('search', 'snpid-search');
     });
     $("#gl_region_search_form").on('submit', function(event){
         event.preventDefault();  //works fine here?
         hideControlsDuringSearch();
         create_search_post('search', 'gl-region-search');
     });
     $("#gene_name_form").on('submit', function(event){
         event.preventDefault();
         hideControlsDuringSearch();
         create_search_post('search', 'gene-name-search');
     });
     $("#tf_search_form").on('submit', function(event){
         event.preventDefault();
         hideControlsDuringSearch();
         create_search_post('search', 'trans-factor-search');
     });
    }






    function hideControlsDuringSearch(){
         $("div#form_errors").empty();
         $("#search_results").remove();   
         $("#drop-in").empty();
    }


 
    function showHidePrevNext(search_paging_info){
        if ( (search_paging_info != null) && (search_paging_info.show_next_btn) ){
          $("#ajaxyPagingButtons #next_button").attr("style", "display:inline;"); 
        }else{
          $("#ajaxyPagingButtons #next_button").attr("style", "display:none;"); 
        }
        if ( (search_paging_info != null) && (search_paging_info.show_prev_btn) ){
          $("#ajaxyPagingButtons #prev_button").attr("style", "display:inline;"); 
        }else{ 
          $("#ajaxyPagingButtons #prev_button").attr("style", "display:none;"); 
        }
    }


    function setupPlotDownloadsForSearchResults(){
       var btn = document.querySelector('button#save_plot');
       var canvas =  document.querySelector('canvas');

         btn.addEventListener('click', function () {
         var svg = document.querySelector('div.show-plot > svg');
         svg = svg.cloneNode(true); //can I make a deep copy?
         svg.setAttribute("id", "tempSVG");
         // works OK
         //appends   the definitions
         var defs = d3.select(svg).append("defs").append("marker")
                                     .attr("id","Triangle")
                                     .attr("markerWidth","5")
                                     .attr("markerHeight","3")
                                     .attr("stroke", "blue")
                                     .attr("orient", "auto")
                                     .attr("viewBox", "0 0 10 10")
                                     .attr('refX', '1')
                                     .attr('refY', '5')
                                     .append("path").attr("d", "M 0 0 L 10 5 L 0 10 z");
          var canvas = document.getElementById('canvas');
          canvas.setAttribute('width',  $("div.show-plot svg").attr('width'));
          //400 - 30 = 370
          var ctx = canvas.getContext('2d');

          // Reset the canvas to remove any plots drawn before this one 
          //taken from :http://www.html5canvastutorials.com/advanced/html5-clear-canvas/ 
          ctx.clearRect(0, 0, canvas.width, canvas.height);

     
          var data = (new XMLSerializer()).serializeToString(svg);
          var DOMURL = window.URL || window.webkitURL || window;

          var img = new Image();
          console.log("just created new img.");
          var svgBlob = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
          var url = DOMURL.createObjectURL(svgBlob);

          img.onload = function () {
            console.log("about to call drawImage");
            ctx.drawImage(img, 0, -30);
            DOMURL.revokeObjectURL(url);

            //d3.selectAll('div.show-plot > svg > defs').remove();
            //console.log("remove defs..");

            var imgURI = canvas
                .toDataURL('image/png')
                .replace('image/png', 'image/octet-stream');

            triggerDownload(imgURI);
            console.log("returned from trigger download");
          };
      
          img.src = url;

          });
    }//endable plot downloading code.


    function setupPlotsForSearchResults(){

        $("td.show_plots > button").click(function(e) {
                  //var plotstr_attr = e.target.attributes.getNamedItem('plotstr');
                  var plot_button_id = e.target.attributes.getNamedItem('id').value;
                  var plot_str = plot_button_id.replace('show_plot_', '');
                  console.log("plot_str: " + plot_str);
                      //var plot_str  = plotstr_attr.value;

                  /* hides the currently shown plot */
                  //console.dir(e.target);
                  //var jtarget = $("td#plot_data_".concat(plot_str));
                  //var json_to_plot = jtarget[0].textContent.trim();

                  //plottingData = jQuery.parseJSON(json_to_plot); 
                  //console.log("json to plot: " + plottingData);
                  
                  // makeAPlot(plottingData, "target-0"); 
                  /* the code below would be useful for showing/hiding
                     all of the plots prepared for this one page */ 
 
                  /*  hiding the shown plot breaks if it's not there..*/
                  var currently_shown_plot = $("div.show-plot");
                  if (currently_shown_plot.length > 0){
                      currently_shown_plot.removeClass('show-plot');
                      currently_shown_plot.addClass('hidden'); 
                  }
                  var id_of_plot_svg = 'target-'.concat(plot_str); 
                  var plot_selector = 'svg#'.concat(id_of_plot_svg);
                  console.log("show plot was clicked, id = " + id_of_plot_svg);
                  var div_to_show_now = $(plot_selector).parent();
                  console.log("div_to_show_now = ");
                  console.log( div_to_show_now );
                  div_to_show_now.removeClass('hidden');
                  div_to_show_now.addClass('show-plot');
                  $(plot_selector).attr('style', 'display: inline;');
                  /*window.scrollTo(0, 0);  scroll to the top of the page */
                 }); 

       var plottingData = [];
       $("td.plotting_data" ).each(function() {
           var data_for_one_plot = this.textContent;
           onePlotData = jQuery.parseJSON(data_for_one_plot);
           plottingData.push(onePlotData);
           //console.log("preparing for one plot.. " + data_for_one_plot ); 
       });
       cloneSVGSkeleton(plottingData);
       $("svg#target-0").hide();
       for ( var n = 0; n < plottingData.length; n++){
           var targetSVGid = "target-" + plottingData[n].plot_id_str;
           //console.log("creating plot for id : " + targetSVGid);
           makeAPlot(plottingData[n], targetSVGid);
           if ( n > 0 ){
             //console.log("adding hidden class to " + targetSVGid);
             $("#"+targetSVGid).parent().addClass("hidden");
           }else {
             $("#save_plot").attr('style', 'display: inline;');
             $("#"+targetSVGid).parent().addClass("show-plot");
           } 
           var plotToMove = $("#"+targetSVGid).parent().detach();
           var idOfPlotTarget = "#" + targetSVGid.replace('target-', 'show_plot_');
           var putPlotHere = $(idOfPlotTarget).parent();
           plotToMove.appendTo(putPlotHere);
       } 
       console.log("completed plotting!");
      }

          //take the search results and put them into the document.
          function show_search_results(json) {
            showHidePrevNext(json.search_paging_info);
            //if it's null, no buttons will be shown.

            $("#download_button").attr("style", "display: inline;");
            var content = `<table id="search_results" class="table table-striped table-condensed"> \
              <thead>                                                         \   
              <tr>                                     \ 
                  <td>SNPid                    </td>   \ 
                  <td>Chromosome               </td>   \ 
                  <td>Position                 </td>   \ 
                  <td>Reference Allele         </td>   \ 
                  <td>SNP Allele               </td>   \ 
                  <td>p-value Rank             </td>   \ 
                  <td>Log Likelihood Reference </td>   \ 
                  <td>Log Likelihood SNP       </td>   \ 
                  <td>Log Likelihood Ratio     </td>   \ 
                  <td>p-value Reference        </td>   \ 
                  <td>p-value SNP              </td>   \ 
                  <td>p-value Difference       </td>   \ 
                  <td>Transcription Factor     </td>   \ 
                  <td>Motif                    </td>   \ 
                  <td>Show Plot                </td>   \ 
              </tr>                                    \ 
              </thead>                                 \ 
              <tbody>`;                                
              $("#drop-in").append(content);
              var rows = "";
              for (var i = 0; i < json.api_response.length; i ++){
                  rows += "<tr>";
                  rows += "<td>" + json.api_response[i].snpid + "</td>";   
                  rows += "<td>" + json.api_response[i].chr + "</td>";   
                  rows += "<td>" + json.api_response[i].pos + "</td>";   
                  rows += "<td>" + json.api_response[i].refAllele + "</td>";   
                  rows += "<td>" + json.api_response[i].snpAllele + "</td>";   
                  rows += "<td>" + json.api_response[i].pval_rank.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].log_lik_ref.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].log_lik_snp.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].log_lik_ratio.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].pval_ref.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].pval_snp.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].pval_diff.toExponential(3) + "</td>";   
                  rows += "<td>" + json.api_response[i].trans_factor + "</td>";   
                  rows += "<td>" + json.api_response[i].motif + "</td>";   
                  rows += '<td class="show_plots"> <button id="show_plot_' 
                           + json.api_response[i].plot_id_str + '" type="button"';
                  rows +=  ' class="btn btn-link" plotstr="' + 
                            + json.api_response[i].plot_id_str + '" ' +
                            'title="Show the plot for this data.">'; 
                  rows += 'Show Plot</button></td>';
                  rows += '<td id="plot_data_'  + json.api_response[i].plot_id_str +  '" style="display:none;"';
                  rows += ' class="plotting_data">' + json.api_response[i].json_for_plotting + '</td>';
                  rows += "</tr>";
              }
              $("#drop-in table tbody").append(rows);
              setupPlotsForSearchResults(); //copied (should be fully moved) out of document.ready
          }//end of show_search_results function.


       //TODO: determine if search type is a needed parameter for these.
       function create_search_post(action_name, search_type){
         var formElement = document.querySelector('div.active form');
         form_data = new FormData(formElement); 
         console.log(form_data.getAll('pvalue_rank_cutoff'));
         console.log("getAll returns: " + form_data.getAll('pvalue_rank_cutoff'));
         

         form_data['search_type'] = search_type;
         form_data['action'] = action_name


         var url_endpoint = 'ajaxy-' + search_type + '/';

         console.log(form_data.getAll('pvalue_rank_cutoff'));  //is the form working?

         $("div#status_message").text("Working... ");
         $("div#download_button").attr("style", "display:none;");
         showHidePrevNext(null); 
         //hides the search buttons while we are working...

          console.log("about to send ajax to endpoint " +
                      url_endpoint +  " with these values:");
          $.ajax({
              beforeSend: function(xhr, settings) {
                   if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                       xhr.setRequestHeader("X-CSRFToken", csrftoken);
                   }
                   var target = $("body");
                   var spinner = new Spinner().spin();
                   target.append(spinner.el);
                   console.log("appended spinner!");
              },
              url: url_endpoint, //url: "ajaxy-snpid-window-search/",
              type: "POST", 
              data: form_data, //data: values , 
              processData: false,
              cache: false,
              contentType: false,
             
              success: function(json) {
                  console.log("AJAX call reported success. Next line w/ response");
                  console.log(json);
                  $("div#status_message").text(json.status_message);

                  if ( json.api_response != null){
                      show_search_results(json);
                  }
                  //save data about the search onto the page: 
                  //search type
                    $("#type_of_shown_results").text(search_type);

                  //what about just grabbing the form data that is sent back?
                  console.log(json.form_data); //try to grab the values out of here.

                  //JSON dict containing search params that correspond to any 
                  //search results shown.
                  
                   var values = {};
                   /*for(var pair of form_data.entries()) {
                      values[pair[0]] = pair[1]; //set the values into the JSON dict.
                      console.log(pair[0]+ ', '+ pair[1]); 
                   }*/

                  values = json.form_data; //does it work to just store the dict directly and re-copy it?
                  if (json.search_paging_info != null){ 
                      values.page_of_results_shown =
                              json.search_paging_info.page_of_results_to_display;
                      console.log("...setting page number of results shown to:" + values.page_of_results_shown);
                  }
                  //this should contain a correct version of page_of_results_shown.
                  var values_to_save_for_paging = JSON.stringify(values);
                  console.log("values to persist after successful search: " + values_to_save_for_paging);
                  $("div#current_search_params").text(values_to_save_for_paging);

              },
              error: function(xhr, errmsg, err) {
                  /* would put code down here to append error messages onto the search page.*/
                  console.log(xhr.status + ": " + xhr.responseText);
                  //MOVE THIS TO ITS OWN FUNCTION:
                  var errorJSON = jQuery.parseJSON(xhr.responseText);
                  var errlist = '<ul>';
                  for ( var j = 0; j < errorJSON.form_errors.length; j++){
                      errlist += '<li>' + errorJSON.form_errors[j] + '</li>';
                  } 
                  errlist += '</ul>';
                  $("div#form_errors").append(errlist);
                  $("div#status_message").text(errorJSON.status_message);
                  showHidePrevNext(null); //hides the next and previous buttons.
              },
              complete: function(){
                  console.log("complete is acctually happenning; do shared stuff if this triggers for success AND error.");
                  $("div.spinner").remove();
              }
          });              

       }

       //search type should already be present.
       //some of this can be factored out...
       function create_paging_post(action_name, search_type){
         //ignore all the form stuff if paging.. 
         //copy into a 'values'  div; do this after search so it can be updated?
         var val_text = $("div#current_search_params").text();
         var values = jQuery.parseJSON(val_text);
         values['action'] = action_name
         var url_endpoint = 'ajaxy-' + search_type + '/';
         $("div#status_message").text("Working... ");
         $("div#download_button").attr("style", "display:none;");
         showHidePrevNext(null); 
         //hides the search buttons while we are working...

          console.log("about to send ajax to endpoint " +
                      url_endpoint +  " with these values:");
          console.log(values);
          $.ajax({
              beforeSend: function(xhr, settings) {
                   if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                       xhr.setRequestHeader("X-CSRFToken", csrftoken);
                   }
                   var target = $("body");
                   var spinner = new Spinner().spin();
                   target.append(spinner.el);
                   console.log("appended spinner!");
              },
              url: url_endpoint, //url: "ajaxy-snpid-window-search/",
              type: "POST", 
              data: values , 
             
              success: function(json) {
                  console.log("PAGING: AJAX call reported success. Next line w/ response");
                  console.log(json);

                  //this should contain a correct version of page_of_results_shown.
                  $("div#status_message").text(json.status_message);

                  if ( json.api_response != null){
                      show_search_results(json);
                  }
                  if (json.search_paging_info != null){ 
                      values.page_of_results_shown =
                              json.search_paging_info.page_of_results_to_display;
                      console.log("...setting page number of results shown to:" + values.page_of_results_shown);
                  }
                  //$("#type_of_shown_results").text(search_type);//would this not have been set before?
                  var values_to_save_for_paging = JSON.stringify(values);
                  $("div#current_search_params").text(values_to_save_for_paging);
              },
              error: function(xhr, errmsg, err) {
                  console.log(xhr.status + ": " + xhr.responseText);
                  //MOVE THIS TO ITS OWN FUNCTION: can be shared 
                  var errorJSON = jQuery.parseJSON(xhr.responseText);
                  var errlist = '<ul>';
                  for ( var j = 0; j < errorJSON.form_errors.length; j++){
                      errlist += '<li>' + errorJSON.form_errors[j] + '</li>';
                  } 
                  errlist += '</ul>';
                  $("div#form_errors").append(errlist);
                  $("div#status_message").text(errorJSON.status_message);
                  showHidePrevNext(null); //hides the next and previous buttons.
              },
              complete: function(){
                  console.log("complete is acctually happenning; do shared stuff if this triggers for success AND error.");
                  $("div.spinner").remove();
              }
          });              
       }
      //define the FormData based on the currently shown form.
      //Then copy the values into a dict 
      //that dict will be used for paging; 
      function create_post(action_name, search_type) {
          if ( (action_name != 'Next') && 
               (action_name != 'Prev') ){
         //var formElement = document.querySelector('#form_snpid_search');
         var formElement = document.querySelector('div.active form');
         fd = new FormData(formElement); 
         console.log(fd.getAll('pvalue_rank_cutoff'));
         console.log("getAll returns: " + fd.getAll('pvalue_rank_cutoff'));
         //can I still get data with a more general selector?
for(var pair of formData.entries()) {
   console.log(pair[0]+ ', '+ pair[1]); 
}
            /* var values;
            var controls_to_scrape = $("div.active form .form-control[id^='id']");
            var values = {};
            for ( var i = 0; i < controls_to_scrape.length; i ++){
                var one_id = controls_to_scrape[i].getAttribute('id');
                one_id = one_id.replace('id_', '');
                var one_value = controls_to_scrape[i].value.trim();
                values[one_id] = one_value;
                form_data[one_id] = one_value;
                console.log("appending form data");

            }
            //if this otherwise works; add any Files and see if that works.
            //not sure if this is needed.
            */
            form_data = fd;
            form_data['search_type'] = search_type;
            values = form_data; 
          }
          else{ //if it's for paging, use the values we copied down earlier...
              var val_text = $("div#current_search_params").text();
              values = jQuery.parseJSON(val_text);
          } 
          values['action'] = action_name;
          var url_endpoint = 'ajaxy-' + search_type + '/';

          console.log(form_data.getAll('pvalue_rank_cutoff'));
          $("div#status_message").text("Working... ");
          $("div#download_button").attr("style", "display:none;");

          showHidePrevNext(null); 
          //hides the search buttons while we are working...

          console.log("about to send ajax to endpoint " +
                      url_endpoint +  " with these values:");
          console.log(values);
          $.ajax({
              beforeSend: function(xhr, settings) {
                   if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                       xhr.setRequestHeader("X-CSRFToken", csrftoken);
                   }
                   var target = $("body");
                   var spinner = new Spinner().spin();
                   target.append(spinner.el);
                   console.log("appended spinner!");
              },
              url: url_endpoint, //url: "ajaxy-snpid-window-search/",
              type: "POST", 
              data: form_data, //data: values , 
              processData: false,
              cache: false,
              contentType: false,
             
              success: function(json) {
                  console.log("AJAX call reported success. Next line w/ response");
                  console.log(json);
                  if ( json.api_response != null){
                      show_search_results(json);
                  }
                  if (json.search_paging_info != null){ 
                      values.page_of_results_shown =
                              json.search_paging_info.page_of_results_to_display;
                      console.log("...setting page number of results shown to:" + values.page_of_results_shown);
                  }
                  $("#type_of_shown_results").text(search_type);
                  var values_to_save_for_paging = JSON.stringify(values);
                  $("div#current_search_params").text(values_to_save_for_paging);
                  //this should contain a correct version of page_of_results_shown.
                  $("div#status_message").text(json.status_message);

              },
              error: function(xhr, errmsg, err) {
                  /* would put code down here to append error messages onto the search page.*/
                  console.log(xhr.status + ": " + xhr.responseText);
                  //MOVE THIS TO ITS OWN FUNCTION:
                  var errorJSON = jQuery.parseJSON(xhr.responseText);
                  var errlist = '<ul>';
                  for ( var j = 0; j < errorJSON.form_errors.length; j++){
                      errlist += '<li>' + errorJSON.form_errors[j] + '</li>';
                  } 
                  errlist += '</ul>';
                  $("div#form_errors").append(errlist);
                  $("div#status_message").text(errorJSON.status_message);
                  showHidePrevNext(null); //hides the next and previous buttons.
              },
              complete: function(){
                  console.log("complete is acctually happenning; do shared stuff if this triggers for success AND error.");
                  $("div.spinner").remove();
              }
          });              

          }//end of create_post function.


       //may be factored back into other create_post function; separate for now.

      //SOURCE:
      //http://stackoverflow.com/questions/28165424/download-file-via-jquery-ajax-post
      function create_download_post(search_type) {
          var val_text = $("div#current_search_params").text();
          values = jQuery.parseJSON(val_text);
          values['action'] = 'Download Results';
          var result_text = $("div#status_message").text();
          $("div#status_message").text("Working... ");

          var url_endpoint = 'ajaxy-' + search_type + '/';

          xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
              var a;
              if (xhttp.readyState === 4 && xhttp.status === 200) {
                  a = document.createElement('a');
                  a.href = window.URL.createObjectURL(xhttp.response);
                  a.download = "search-results-download.csv";
                  a.style.display = 'none';
                  document.body.appendChild(a);
                  a.click();
                  $("div#status_message").text(result_text);
              }
          };
          //var download_url = "ajaxy-snpid-window-search/";
          xhttp.open("POST", url_endpoint);
          xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
          xhttp.setRequestHeader("X-CSRFToken", csrftoken);
         
          console.log("values for submitting for download; "+ values);

          // You should set responseType as blob for binary responses
          xhttp.responseType = 'blob';
          xhttp.withCredentials = true;
          xhttp.send(JSON.stringify(values));
        }

      //to be removed.
      function clickNext(){
           var active_search = $("span#type_of_shown_results")[0].innerText.trim();
           if (active_search == 'snpid'){
              $("div#snpid_search_form input[value='Next']").click();
           } else if (active_search == 'snpid-window'){
              $("div#snpid_window_form input[value='Next']").click();
           } else if (active_search == 'gl-region'){
              $("div#gl_region_search_form input[value='Next']").click();
           } else if (active_search == 'gene-name'){
              $("div#gene_name_form input[value='Next']").click();
           } else if (active_search == 'tf'){
              $("div#tf_search_form input[value='Next']").click();
           }
      }

      function clickNextAJAX(){
           var active_search = $("span#type_of_shown_results")[0].innerText.trim();
           console.log("clicked next AJAX active_search." + active_search);
           //copied out of the form's on_submit event handler  
           $("div#form_errors").empty();
           $("#search_results").remove();   
           $("#drop-in").empty();
           //create_post('Next', active_search); //action name, search type
           create_paging_post('Next', active_search);
      }

      function clickPrevAJAX(){
           var active_search = $("span#type_of_shown_results")[0].innerText.trim();
           console.log("clicked prev AJAX active_search." + active_search);
           //copied out of the form's on_submit event handler  
           $("div#form_errors").empty();
           $("#search_results").remove();   
           $("#drop-in").empty();
           //create_post('Prev', active_search); //action name, search type
           create_paging_post('Prev', active_search);
      }
      //this may need to change.
      function clickDownloadResultsAJAX(){
           var active_search = $("span#type_of_shown_results")[0].innerText.trim();
           console.log("clicked Donwload Results AJAX active_search." + active_search);
           create_download_post(active_search); //action name, search type
      }
      function clickPrev(){
           var active_search = $("span#type_of_shown_results")[0].innerText.trim();
           if (active_search == 'snpid'){
              $("div#snpid_search_form input[value='Prev']").click();
           } else if (active_search == 'snpid-window'){
              $("div#snpid_window_form input[value='Prev']").click();
           } else if (active_search == 'gl-region'){
              $("div#gl_region_search_form input[value='Prev']").click();
           } else if (active_search == 'gene-name'){
              $("div#gene_name_form input[value='Prev']").click();
           } else if (active_search == 'tf'){
              $("div#tf_search_form input[value='Prev']").click();
           }
      }


    $(".formcontrol").tooltip({
      position: "bottom left",
      offset: [-2, 10],
      opacity: 0.1
    });

    //handle CSRF token for AJAX requests.
    // using jQuery
    function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    /* if this works; define the getCookie function in an external file*/
   
   function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

</script>
</body>


